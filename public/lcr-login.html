<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCR Login</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: #f8f9fa;
            color: #333;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 400px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Logging into LCR...</h2>
        <div id="status" class="status">
            Loading Church login page...
        </div>

        <div id="iframe-container" style="display: none; margin-top: 1rem; width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
            <iframe id="lcr-iframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>

    <script>
        // Simple redirect to LCR - let the Church handle the OAuth flow
        const lcrUrl = 'https://lcr.churchofjesuschrist.org';

        // Function to update status
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // Function to check iframe for login success
        function checkIframeLogin() {
            try {
                const iframe = document.getElementById('lcr-iframe');
                if (!iframe || !iframe.contentWindow) {
                    return false;
                }
                
                const iframeDoc = iframe.contentWindow.document;
                const iframeUrl = iframe.contentWindow.location.href;
                
                console.log('Checking iframe login... URL:', iframeUrl);
                console.log('Iframe title:', iframeDoc.title);
                console.log('Iframe content includes LCR:', iframeDoc.body.textContent.includes('Leader and Clerk Resources'));
                console.log('Iframe content includes Shawn Lane:', iframeDoc.body.textContent.includes('Shawn Lane'));
                
                // Check for login indicators in iframe
                const isLoggedIn = 
                    iframeUrl === 'https://lcr.churchofjesuschrist.org/' ||
                    iframeUrl === 'https://lcr.churchofjesuschrist.org' ||
                    iframeDoc.title.includes('LCR') ||
                    iframeDoc.title.includes('Leader and Clerk Resources') ||
                    iframeDoc.querySelector('input[placeholder*="Find members"]') !== null ||
                    iframeDoc.querySelector('input[placeholder*="Search"]') !== null ||
                    iframeDoc.body.textContent.includes('Leader and Clerk Resources') ||
                    iframeDoc.body.textContent.includes('Shawn Lane');
                
                if (isLoggedIn) {
                    console.log('Login detected in iframe! Closing popup...');
                    updateStatus('Login successful! Closing popup...', 'success');
                    
                    // Send message to parent window
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'LCR_LOGIN_SUCCESS',
                            timestamp: Date.now()
                        }, '*');
                        console.log('Sent success message to parent window');
                    }
                    
                    // Close popup after a short delay
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                console.log('Error checking iframe login:', error);
                return false;
            }
        }
        
        // Function to check if we're logged in (for direct navigation)
        function checkIfLoggedIn() {
            console.log('Checking login status... Current URL:', window.location.href);
            console.log('Document title:', document.title);
            console.log('Page content includes LCR:', document.body.textContent.includes('Leader and Clerk Resources'));
            console.log('Search input found:', document.querySelector('input[placeholder*="Find members"]') !== null);
            console.log('Profile name found:', document.body.textContent.includes('Shawn Lane'));
            
            // Check if we're on the LCR main page with the exact URL pattern
            if (window.location.href === 'https://lcr.churchofjesuschrist.org/' || 
                window.location.href === 'https://lcr.churchofjesuschrist.org') {
                
                console.log('Detected LCR main page URL!');
                updateStatus('Login successful! Closing popup...', 'success');
                
                // Send message to parent window
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'LCR_LOGIN_SUCCESS',
                        timestamp: Date.now()
                    }, '*');
                    console.log('Sent success message to parent window');
                }
                
                // Close popup after a short delay
                setTimeout(() => {
                    window.close();
                }, 1000);
                
                return true;
            }
            
            // Also check for other LCR URLs as fallback
            if (window.location.hostname === 'lcr.churchofjesuschrist.org') {
                console.log('On LCR domain, checking for login indicators...');
                
                // Check for various indicators of successful login
                const isLoggedIn = 
                    window.location.pathname === '/' || 
                    window.location.pathname.includes('dashboard') ||
                    window.location.pathname.includes('home') ||
                    window.location.pathname.includes('callback') ||
                    document.title.includes('LCR') ||
                    document.title.includes('Leader and Clerk Resources') ||
                    document.querySelector('input[placeholder*="Find members"]') !== null ||
                    document.querySelector('input[placeholder*="Search"]') !== null ||
                    document.body.textContent.includes('Leader and Clerk Resources') ||
                    document.body.textContent.includes('Shawn Lane'); // Your name as indicator
                
                if (isLoggedIn) {
                    console.log('Login detected via fallback! Closing popup...');
                    updateStatus('Login successful! Closing popup...', 'success');
                    
                    // Send message to parent window
                    if (window.opener) {
                        window.opener.postMessage({
                            type: 'LCR_LOGIN_SUCCESS',
                            timestamp: Date.now()
                        }, '*');
                        console.log('Sent success message to parent window');
                    }
                    
                    // Close popup after a short delay
                    setTimeout(() => {
                        window.close();
                    }, 1000);
                    
                    return true;
                }
            }
            
            return false;
        }

        // Simple redirect to LCR
        updateStatus('Redirecting to Church login page...');
        
        // Redirect to LCR
        window.location.href = lcrUrl;

        // Set up periodic checking for login success (simplified)
        const checkInterval = setInterval(() => {
            if (checkIfLoggedIn()) {
                clearInterval(checkInterval);
            }
        }, 2000);
        
        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            console.log('Received message in LCR popup:', event.data);
            
            if (event.data && event.data.type === 'FETCH_LCR_DATA') {
                console.log('Received fetch request from parent window');
                updateStatus('Fetching data from LCR...', 'info');
                
                // Wait a moment to ensure we're fully loaded, then fetch
                setTimeout(() => {
                    window.fetchLCRData();
                }, 1000);
            }
        });

        // Show manual close button immediately if we're on LCR domain
        if (window.location.hostname === 'lcr.churchofjesuschrist.org') {
            const manualClose = document.getElementById('manual-close');
            if (manualClose) {
                manualClose.style.display = 'block';
                updateStatus('You appear to be on the LCR page. If you are logged in, click the button below to close the popup.', 'info');
            }
        } else {
            // Show manual close button after 30 seconds as fallback
            setTimeout(() => {
                const manualClose = document.getElementById('manual-close');
                if (manualClose) {
                    manualClose.style.display = 'block';
                    updateStatus('If you are logged in, click the button below to close the popup.', 'info');
                }
            }, 30000);
        }
        
        // Timeout after 5 minutes
        setTimeout(() => {
            clearInterval(checkInterval);
            clearInterval(urlCheckInterval);
            updateStatus('Login timeout. Please try again.', 'error');
        }, 300000);
        
        // Manual close function
        window.closePopup = function() {
            if (window.opener) {
                window.opener.postMessage({
                    type: 'LCR_LOGIN_SUCCESS',
                    timestamp: Date.now()
                }, '*');
            }
            window.close();
        };
        
        // Function to fetch LCR data from within the popup
        window.fetchLCRData = async function() {
            try {
                console.log('Fetching LCR data from popup...');
                updateStatus('Fetching member data from LCR...', 'info');
                
                const response = await fetch('https://lcr.churchofjesuschrist.org/api/report/custom-reports/run-report/270dd333-769f-43a0-b73e-d27cc6d5d730?lang=eng', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                
                const json = await response.json();
                console.log('LCR data fetched successfully:', json);
                updateStatus('Data fetched successfully! Sending to main app...', 'success');
                
                // Send data back to parent window
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'LCR_DATA_FETCHED',
                        data: json,
                        timestamp: Date.now()
                    }, '*');
                    
                    // Close popup after successful data transfer
                    setTimeout(() => {
                        updateStatus('Closing popup...', 'info');
                        window.close();
                    }, 1000);
                }
                
                return json;
            } catch (error) {
                console.error('Error fetching LCR data:', error);
                updateStatus('Error fetching data: ' + error.message, 'error');
                
                // Send error back to parent window
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'LCR_DATA_ERROR',
                        error: error.message,
                        timestamp: Date.now()
                    }, '*');
                }
                
                throw error;
            }
        };
    </script>
</body>
</html> 